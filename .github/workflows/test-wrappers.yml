name: Test Wrappers

on:
  pull_request:
    paths:
      - 'wrappers/**'
      - 'examples/**'
      - 'tests/**'
  push:
    branches:
      - main
    paths:
      - 'wrappers/**'
      - 'examples/**'
      - 'tests/**'

jobs:
  test_python:
    name: Test Python Wrapper
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        cd wrappers/python
        pip install -e .
        pip install pytest pytest-cov

    - name: Run Python tests
      run: |
        cd tests/integration
        python -m pytest test_python.py -v --cov=../../wrappers/python

    - name: Run Python examples
      run: |
        cd examples/python
        python kyber_demo.py
        python dilithium_demo.py

  test_nodejs:
    name: Test Node.js Wrapper
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['16', '18', '20']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Node.js dependencies
      run: |
        cd wrappers/nodejs
        npm install

    - name: Run Node.js tests
      run: |
        cd wrappers/nodejs
        npm test

    - name: Run Node.js examples
      run: |
        cd examples/nodejs
        npm install
        node kyber_demo.js

  test_go:
    name: Test Go Wrapper
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.19', '1.20', '1.21']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}

    - name: Run Go tests
      run: |
        cd wrappers/go
        go mod tidy
        go test -v ./...

    - name: Run Go examples
      run: |
        cd examples/go
        go mod tidy
        go run main.go

  test_rust:
    name: Test Rust Wrapper
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust-version: ['stable', 'beta']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Rust ${{ matrix.rust-version }}
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ matrix.rust-version }}
        profile: minimal
        override: true

    - name: Run Rust tests
      uses: actions-rs/cargo@v1
      with:
        command: test
        args: --manifest-path wrappers/rust/Cargo.toml --verbose

    - name: Run Rust examples
      uses: actions-rs/cargo@v1
      with:
        command: run
        args: --manifest-path examples/rust/Cargo.toml

  test_binaries:
    name: Test Binary Integrity
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Test binary integrity
      shell: bash
      run: |
        chmod +x tests/test_binaries.sh
        ./tests/test_binaries.sh