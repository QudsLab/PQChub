name: Build Binaries

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      pqclean_ref:
        description: 'PQClean branch/tag/commit to build'
        required: false
        default: 'master'
        type: string

env:
  PQCLEAN_REF: ${{ github.event.inputs.pqclean_ref || 'master' }}

jobs:
  build_native:
    name: Build Native (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
            target: linux-x86_64
            cross: false
          - os: linux
            arch: aarch64
            runner: ubuntu-latest
            target: linux-aarch64
            cross: true
          
          # macOS builds
          - os: macos
            arch: x86_64
            runner: macos-15-intel  # Intel runner
            target: macos-x86_64
            cross: false
          - os: macos
            arch: arm64
            runner: macos-latest  # Apple Silicon runner
            target: macos-arm64
            cross: false
          
          # Windows builds
          - os: windows
            arch: x64
            runner: windows-latest
            target: windows-x64
            cross: false
          - os: windows
            arch: x86
            runner: windows-latest
            target: windows-x86
            cross: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # Linux-specific setup
    - name: Setup Linux build tools
      if: matrix.os == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        if [ "${{ matrix.cross }}" = "true" ]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi

    # Windows-specific setup
    - name: Setup Windows MSVC
      if: matrix.os == 'windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.arch }}

    # Clone PQClean source
    - name: Clone PQClean
      run: git clone --depth 1 --branch ${{ env.PQCLEAN_REF }} https://github.com/PQClean/PQClean.git pqclean-source

    - name: DEBUG - Check what was cloned
      shell: bash
      run: |
        pwd
        ls -la
        echo "--- pqclean-source exists? ---"
        ls -la pqclean-source/ | head -20
        echo "--- common dir ---"
        ls pqclean-source/common/ || echo "MISSING"
        echo "--- falcon-512 dir ---"
        ls pqclean-source/crypto_sign/falcon-512/clean/ || echo "MISSING"
        echo "--- Check actual file ---"
        test -f pqclean-source/crypto_sign/falcon-512/clean/codec.c && echo "FILE EXISTS" || echo "FILE MISSING"

    # Build native library
    - name: Build (Unix)
      if: matrix.os != 'windows'
      run: |
        chmod +x scripts/build_native.sh
        ./scripts/build_native.sh ${{ matrix.target }} pqclean-source
      env:
        CC: ${{ matrix.cross && matrix.arch == 'aarch64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
        CXX: ${{ matrix.cross && matrix.arch == 'aarch64' && 'aarch64-linux-gnu-g++' || 'g++' }}

    - name: Build (Windows)
      if: matrix.os == 'windows'
      run: python scripts/build_native.py ${{ matrix.target }} pqclean-source

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ matrix.target }}
        path: bins/${{ matrix.target }}/
        retention-days: 7

  build_android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi:
          - arm64-v8a
          - armeabi-v7a
          - x86_64
          - x86

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c

    - name: Clone PQClean
      run: git clone --depth 1 --branch ${{ env.PQCLEAN_REF }} https://github.com/PQClean/PQClean.git pqclean-source

    - name: Build Android library
      run: |
        chmod +x scripts/build_android.sh
        ./scripts/build_android.sh ${{ matrix.abi }} pqclean-source
      env:
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-android-${{ matrix.abi }}
        path: bins/android-${{ matrix.abi }}/
        retention-days: 7