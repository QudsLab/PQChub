name: Build Binaries

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      pqclean_ref:
        description: 'PQClean branch/tag/commit to build'
        required: false
        default: 'master'
        type: string

env:
  PQCLEAN_REF: ${{ github.event.inputs.pqclean_ref || 'master' }}

jobs:
  build_native:
    name: Build Native (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
            target: linux-x86_64
            cross: false
          - os: linux
            arch: aarch64
            runner: ubuntu-latest
            target: linux-aarch64
            cross: true
          
          # macOS builds
          - os: macos
            arch: x86_64
            runner: macos-13  # Intel runner
            target: macos-x86_64
            cross: false
          - os: macos
            arch: arm64
            runner: macos-latest  # Apple Silicon runner
            target: macos-arm64
            cross: false
          
          # Windows builds
          - os: windows
            arch: x64
            runner: windows-latest
            target: windows-x64
            cross: false
          - os: windows
            arch: x86
            runner: windows-latest
            target: windows-x86
            cross: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # Linux-specific setup
    - name: Setup Linux dependencies
      if: matrix.os == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build ccache
        if [ "${{ matrix.cross }}" = "true" ]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi

    # macOS-specific setup
    - name: Setup macOS dependencies
      if: matrix.os == 'macos'
      run: |
        brew install cmake ninja ccache

    # Windows-specific setup
    - name: Setup Windows dependencies
      if: matrix.os == 'windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.arch }}

    # Cache setup
    - name: Setup ccache
      if: matrix.os != 'windows'
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ matrix.target }}
        max-size: 500M

    - name: Cache PQClean source
      uses: actions/cache@v3
      id: cache-pqclean
      with:
        path: pqclean-source
        key: pqclean-${{ env.PQCLEAN_REF }}-${{ hashFiles('scripts/download_pqclean.py') }}

    # Download PQClean if not cached
    - name: Download PQClean
      if: steps.cache-pqclean.outputs.cache-hit != 'true'
      run: |
        python scripts/download_pqclean.py --output pqclean-source --ref ${{ env.PQCLEAN_REF }}

    # Build native library
    - name: Build native library (Unix)
      if: matrix.os != 'windows'
      run: |
        chmod +x scripts/build_native.sh
        ./scripts/build_native.sh ${{ matrix.target }} pqclean-source
      env:
        CC: ${{ matrix.cross && matrix.arch == 'aarch64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
        CXX: ${{ matrix.cross && matrix.arch == 'aarch64' && 'aarch64-linux-gnu-g++' || 'g++' }}

    - name: Build native library (Windows)
      if: matrix.os == 'windows'
      run: |
        python scripts/build_native.py ${{ matrix.target }} pqclean-source

    # Create build info
    - name: Create build info
      shell: bash
      run: |
        mkdir -p bins/${{ matrix.target }}
        cat > bins/${{ matrix.target }}/README.txt << EOF
        PQChub Native Library - ${{ matrix.target }}
        =============================================
        
        Build Date: $(date -u)
        PQClean Ref: ${{ env.PQCLEAN_REF }}
        GitHub Run: ${{ github.run_id }}
        
        Platform: ${{ matrix.os }}
        Architecture: ${{ matrix.arch }}
        Cross-compiled: ${{ matrix.cross }}
        
        Supported Algorithms:
        - Kyber512, Kyber768, Kyber1024 (KEM)
        - Dilithium2, Dilithium3, Dilithium5 (Signatures)
        - Falcon-512, Falcon-1024 (Signatures)
        
        Usage:
        Load this library using your language's FFI interface.
        See the wrappers/ directory for examples.
        EOF

    # Upload artifacts
    - name: Upload binary artifacts
      uses: actions/upload-artifact@v3
      with:
        name: binaries-${{ matrix.target }}
        path: bins/${{ matrix.target }}/
        retention-days: 7

  build_android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi:
          - arm64-v8a
          - armeabi-v7a
          - x86_64
          - x86

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        add-to-path: false

    - name: Cache PQClean source
      uses: actions/cache@v3
      id: cache-pqclean
      with:
        path: pqclean-source
        key: pqclean-${{ env.PQCLEAN_REF }}-${{ hashFiles('scripts/download_pqclean.py') }}

    - name: Download PQClean
      if: steps.cache-pqclean.outputs.cache-hit != 'true'
      run: |
        python scripts/download_pqclean.py --output pqclean-source --ref ${{ env.PQCLEAN_REF }}

    - name: Build Android library
      run: |
        chmod +x scripts/build_android.sh
        ./scripts/build_android.sh ${{ matrix.abi }} pqclean-source
      env:
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}

    - name: Create build info
      run: |
        mkdir -p bins/android-${{ matrix.abi }}
        cat > bins/android-${{ matrix.abi }}/README.txt << EOF
        PQChub Android Library - ${{ matrix.abi }}
        ==========================================
        
        Build Date: $(date -u)
        PQClean Ref: ${{ env.PQCLEAN_REF }}
        GitHub Run: ${{ github.run_id }}
        
        Platform: Android
        ABI: ${{ matrix.abi }}
        NDK Version: r25c
        
        Supported Algorithms:
        - Kyber512, Kyber768, Kyber1024 (KEM)
        - Dilithium2, Dilithium3, Dilithium5 (Signatures)
        - Falcon-512, Falcon-1024 (Signatures)
        
        Usage:
        Load this library in your Android app using JNI or FFI.
        EOF

    - name: Upload Android artifacts
      uses: actions/upload-artifact@v3
      with:
        name: binaries-android-${{ matrix.abi }}
        path: bins/android-${{ matrix.abi }}/
        retention-days: 7

  commit_binaries:
    name: Commit Binaries to Repository
    needs: [build_native, build_android]
    runs-on: ubuntu-latest
    if: always() && (needs.build_native.result == 'success' || needs.build_android.result == 'success')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download all binary artifacts
      uses: actions/download-artifact@v3
      with:
        path: downloaded-artifacts

    - name: Organize binaries
      run: |
        # Create bins directory structure
        mkdir -p bins
        
        # Move all downloaded artifacts to bins/
        for artifact_dir in downloaded-artifacts/binaries-*; do
          if [ -d "$artifact_dir" ]; then
            target_name=$(basename "$artifact_dir" | sed 's/^binaries-//')
            echo "Processing $target_name"
            mkdir -p "bins/$target_name"
            cp -r "$artifact_dir"/* "bins/$target_name/"
          fi
        done
        
        # Create global build info
        cat > bins/BUILD_INFO.txt << EOF
        PQChub Binary Build Information
        ===============================
        
        Build Date: $(date -u)
        PQClean Reference: ${{ env.PQCLEAN_REF }}
        GitHub Run ID: ${{ github.run_id }}
        GitHub Run Number: ${{ github.run_number }}
        Triggered by: ${{ github.event_name }}
        
        Successfully built platforms:
        $(find bins -name "*.so" -o -name "*.dylib" -o -name "*.dll" | sed 's|bins/||g' | sort)
        
        Algorithms included:
        - Kyber512, Kyber768, Kyber1024 (Key Encapsulation)
        - Dilithium2, Dilithium3, Dilithium5 (Digital Signatures)
        - Falcon-512, Falcon-1024 (Digital Signatures)
        
        Total binary size: $(du -sh bins | cut -f1)
        
        Usage:
        Clone this repository and use the language wrappers in wrappers/
        to access these pre-compiled binaries.
        EOF
        
        # Create binary listing
        cat > bins/BINARIES.txt << EOF
        PQChub Binary Listing
        =====================
        
        $(find bins -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) -exec ls -lh {} \; | sort)
        EOF

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Check for changes
      id: check_changes
      run: |
        git add bins/
        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push binaries
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git commit -m "ü§ñ Auto-update binaries from PQClean ${{ env.PQCLEAN_REF }} [skip ci]

        - Build date: $(date -u)
        - GitHub run: ${{ github.run_id }}
        - Trigger: ${{ github.event_name }}
        - Platforms: $(find bins -name "*.so" -o -name "*.dylib" -o -name "*.dll" | wc -l) binaries
        "
        git push

    - name: Create build summary
      run: |
        echo "## üöÄ Binary Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status | Binary Size |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
        
        for platform_dir in bins/*/; do
          if [ -d "$platform_dir" ]; then
            platform=$(basename "$platform_dir")
            binary_file=$(find "$platform_dir" -name "*.so" -o -name "*.dylib" -o -name "*.dll" | head -1)
            if [ -f "$binary_file" ]; then
              size=$(ls -lh "$binary_file" | awk '{print $5}')
              echo "| $platform | ‚úÖ Built | $size |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $platform | ‚ùå Failed | - |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total binaries**: $(find bins -name "*.so" -o -name "*.dylib" -o -name "*.dll" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "**Total size**: $(du -sh bins | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "**PQClean ref**: ${{ env.PQCLEAN_REF }}" >> $GITHUB_STEP_SUMMARY

  test_wrappers:
    name: Test Language Wrappers
    needs: commit_binaries
    runs-on: ${{ matrix.os }}
    if: needs.commit_binaries.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        language: [python, nodejs]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Pull latest changes
      run: git pull

    - name: Setup Python
      if: matrix.language == 'python'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Node.js
      if: matrix.language == 'nodejs'
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Test Python wrapper
      if: matrix.language == 'python'
      run: |
        cd wrappers/python
        pip install -e .
        python -c "
        try:
            from pqchub import Kyber512
            kyber = Kyber512()
            pk, sk = kyber.keypair()
            ct, ss = kyber.encapsulate(pk)
            ss2 = kyber.decapsulate(ct, sk)
            assert ss == ss2
            print('‚úÖ Python wrapper test passed')
        except Exception as e:
            print(f'‚ùå Python wrapper test failed: {e}')
            exit(1)
        "

    - name: Test Node.js wrapper
      if: matrix.language == 'nodejs'
      run: |
        cd wrappers/nodejs
        npm install
        node -e "
        try {
            const { Kyber512 } = require('./index.js');
            const kyber = new Kyber512();
            const { publicKey, secretKey } = kyber.keypair();
            const { ciphertext, sharedSecret } = kyber.encapsulate(publicKey);
            const decryptedSecret = kyber.decapsulate(ciphertext, secretKey);
            if (Buffer.compare(sharedSecret, decryptedSecret) === 0) {
                console.log('‚úÖ Node.js wrapper test passed');
            } else {
                throw new Error('Shared secrets do not match');
            }
        } catch (e) {
            console.log('‚ùå Node.js wrapper test failed:', e.message);
            process.exit(1);
        }
        "