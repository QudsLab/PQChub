name: Build Binaries

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      pqclean_ref:
        description: 'PQClean branch/tag/commit to build'
        required: false
        default: 'master'
        type: string

env:
  PQCLEAN_REF: ${{ github.event.inputs.pqclean_ref || 'master' }}

permissions:
  contents: write
  actions: read

jobs:
  build_native:
    name: Build Native (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
            target: linux-x86_64
            cross: false
          - os: linux
            arch: aarch64
            runner: ubuntu-latest
            target: linux-aarch64
            cross: true
          
          # macOS builds
          - os: macos
            arch: x86_64
            runner: macos-15-intel  # Intel runner
            target: macos-x86_64
            cross: false
          - os: macos
            arch: arm64
            runner: macos-latest  # Apple Silicon runner
            target: macos-arm64
            cross: false
          
          # Windows builds
          - os: windows
            arch: x64
            runner: windows-latest
            target: windows-x64
            cross: false
          - os: windows
            arch: x86
            runner: windows-latest
            target: windows-x86
            cross: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # Linux-specific setup
    - name: Setup Linux build tools
      if: matrix.os == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        if [ "${{ matrix.cross }}" = "true" ]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi

    # Windows-specific setup
    - name: Setup Windows MSVC
      if: matrix.os == 'windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.arch }}

    # Clone PQClean source
    - name: Clone PQClean
      run: git clone --depth 1 --branch ${{ env.PQCLEAN_REF }} https://github.com/PQClean/PQClean.git pqclean-source

    - name: DEBUG - Check what was cloned
      shell: bash
      run: |
        pwd
        ls -la
        echo "--- pqclean-source exists? ---"
        ls -la pqclean-source/ | head -20
        echo "--- common dir ---"
        ls pqclean-source/common/ || echo "MISSING"
        echo "--- falcon-512 dir ---"
        ls pqclean-source/crypto_sign/falcon-512/clean/ || echo "MISSING"
        echo "--- Check actual file ---"
        test -f pqclean-source/crypto_sign/falcon-512/clean/codec.c && echo "FILE EXISTS" || echo "FILE MISSING"

    # Build native library
    - name: Build (Unix)
      if: matrix.os != 'windows'
      run: |
        chmod +x scripts/build_native.sh
        ./scripts/build_native.sh ${{ matrix.target }} pqclean-source
      env:
        CC: ${{ matrix.cross && matrix.arch == 'aarch64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
        CXX: ${{ matrix.cross && matrix.arch == 'aarch64' && 'aarch64-linux-gnu-g++' || 'g++' }}

    - name: Build (Windows)
      if: matrix.os == 'windows'
      run: python scripts/build_native.py ${{ matrix.target }} pqclean-source

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ matrix.target }}
        path: bins/${{ matrix.target }}/
        retention-days: 7

  build_android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi:
          - arm64-v8a
          - armeabi-v7a
          - x86_64
          - x86

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c

    - name: Clone PQClean
      run: git clone --depth 1 --branch ${{ env.PQCLEAN_REF }} https://github.com/PQClean/PQClean.git pqclean-source

    - name: Build Android library
      run: |
        chmod +x scripts/build_android.sh
        ./scripts/build_android.sh ${{ matrix.abi }} pqclean-source
      env:
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-android-${{ matrix.abi }}
        path: bins/android-${{ matrix.abi }}/
        retention-days: 7

  commit_binaries:
    name: Commit Binaries to Repository
    needs: [build_native, build_android]
    runs-on: ubuntu-latest
    if: always() && (needs.build_native.result == 'success' || needs.build_android.result == 'success')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: downloaded-artifacts

    - name: Organize binaries
      run: |
        # List downloaded artifacts for debugging
        echo "Downloaded artifacts:"
        ls -la downloaded-artifacts/
        
        # Create bins directory structure (preserve existing files like README.md)
        mkdir -p bins
        
        # Move all downloaded artifacts to bins/
        for artifact_dir in downloaded-artifacts/binaries-*; do
          if [ -d "$artifact_dir" ]; then
            target_name=$(basename "$artifact_dir" | sed 's/^binaries-//')
            echo "Processing $target_name"
            echo "  Contents of artifact:"
            ls -la "$artifact_dir/"
            mkdir -p "bins/$target_name"
            cp -rv "$artifact_dir"/* "bins/$target_name/" || true
          fi
        done
        
        # List final bins structure
        echo "Final bins structure:"
        find bins -type f -ls
        
        # Create build info file
        cat > bins/BUILD_INFO.txt << 'EOF'
        PQChub Binary Build Information
        ===============================
        
        Build Date: $(date -u)
        PQClean Reference: ${{ env.PQCLEAN_REF }}
        GitHub Run ID: ${{ github.run_id }}
        GitHub Run Number: ${{ github.run_number }}
        Triggered by: ${{ github.event_name }}
        
        Successfully built platforms:
        EOF
        
        find bins -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) | sed 's|bins/||g' | sort >> bins/BUILD_INFO.txt
        
        echo "" >> bins/BUILD_INFO.txt
        echo "Total binaries: $(find bins -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) | wc -l)" >> bins/BUILD_INFO.txt
        
        # List all binaries
        echo "Built binaries:"
        find bins -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) -ls

    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

    - name: Commit and push binaries
      run: |
        git add bins/
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update binaries from PQClean ${{ env.PQCLEAN_REF }}

          - Build date: $(date -u)
          - GitHub run: ${{ github.run_id }}
          - Trigger: ${{ github.event_name }}
          - Platforms: $(find bins -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) | wc -l) binaries
          
          [skip ci]"
          
          # Pull latest changes and rebase our commit on top
          git pull --rebase origin main
          
          # Push with retry logic
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if git push origin main; then
              echo "Binaries committed and pushed successfully!"
              break
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "Push failed, retrying ($retry_count/$max_retries)..."
                git pull --rebase origin main
                sleep 2
              else
                echo "Failed to push after $max_retries attempts"
                exit 1
              fi
            fi
          done
        fi

    - name: Create build summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status | Binary |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
        
        for platform_dir in bins/*/; do
          if [ -d "$platform_dir" ]; then
            platform=$(basename "$platform_dir")
            binary_file=$(find "$platform_dir" -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) | head -1)
            if [ -f "$binary_file" ]; then
              size=$(ls -lh "$binary_file" | awk '{print $5}')
              echo "| $platform | ✓ Built | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total binaries**: $(find bins -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "**PQClean ref**: ${{ env.PQCLEAN_REF }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

  test_binaries:
    name: Test Binaries (${{ matrix.os }})
    needs: commit_binaries
    runs-on: ${{ matrix.os }}
    if: needs.commit_binaries.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
          - os: macos-latest
            platform: macos-arm64
          - os: windows-latest
            platform: windows-x64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main  # Pull the latest main with committed binaries

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Pull latest changes
      run: git pull origin main

    - name: Verify binary exists
      shell: bash
      run: |
        echo "Checking for binaries in bins/${{ matrix.platform }}/"
        ls -la bins/${{ matrix.platform }}/ || echo "Directory not found"
        
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          binary="bins/${{ matrix.platform }}/pqc.dll"
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          binary="bins/${{ matrix.platform }}/libpqc.dylib"
        else
          binary="bins/${{ matrix.platform }}/libpqc.so"
        fi
        
        if [ -f "$binary" ]; then
          echo "[OK] Binary found: $binary"
          ls -lh "$binary"
        else
          echo "[ERROR] Binary not found: $binary"
          exit 1
        fi

    - name: Run Python test
      shell: bash
      run: |
        echo "Running Python tests..."
        python tests/test_python.py

    - name: Test summary
      if: always()
      shell: bash
      run: |
        echo "## Test Results - ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Python Test | ✓ Passed |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Platform**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY